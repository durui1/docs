(window.webpackJsonp=window.webpackJsonp||[]).push([[323],{690:function(t,s,a){"use strict";a.r(s);var n=a(47),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"在-sprig-boot-简单整合-spring-security"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在-sprig-boot-简单整合-spring-security"}},[t._v("#")]),t._v(" 在 Sprig Boot 简单整合 Spring Security")]),t._v(" "),a("h2",{attrs:{id:"_0-shiro-和-spring-security-类比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_0-shiro-和-spring-security-类比"}},[t._v("#")]),t._v(" 0. Shiro 和 Spring Security 类比")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"right"}},[t._v("Shiro")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("Spring Security")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("SecurityManager")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("AuthenticationProvider")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("Realm"),a("br"),t._v("SimpleAccountRealm"),a("br"),t._v("JdbcRealm")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("UserDetailService"),a("br"),t._v("InMemoryUserDetailsManager"),a("br"),t._v("JdbcDaoImpl")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("AuthenticationInfo"),a("br"),t._v("AuthorizationInfo")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("UserDetails")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("CredentialsMatcher")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("PasswordEncoder")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"right"}},[t._v("Subject")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("Authentication")])])])]),t._v(" "),a("h2",{attrs:{id:"_1-hello-world"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-hello-world"}},[t._v("#")]),t._v(" 1. Hello World")]),t._v(" "),a("p",[t._v("创建一个 Spring Boot 应用，并引入依赖：")]),t._v(" "),a("div",{staticClass:"language-xml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-xml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("org.springframework.boot"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("groupId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("spring-boot-starter-security"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("artifactId")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("dependency")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),a("p",[t._v("编写一个控制器：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RestController")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TestController")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@RequestMapping")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"hello"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("hello")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello SpringSecurity!"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("然后直接启动项目，访问 "),a("a",{attrs:{href:"http://localhost:8080/login",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://localhost:8080/login"),a("OutboundLink")],1),t._v("：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hemiao3000.gitee.io/java-note-img/images/spring-security/img/spring-boot-security-helloworld-01.png",alt:"spring-boot-security-helloworld-01"}})]),t._v(" "),a("p",[t._v("结果打开的是一个登录页面，其实这时候我们的请求已经被保护起来了，要想访问，需要先登录。")]),t._v(" "),a("p",[t._v("在这个案例中仅仅是引入了一个 Spring Security 的 starter 启动器，没有做任何的配置，而项目已经具有了权限认证。")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hemiao3000.gitee.io/java-note-img/images/spring-security/img/spring-boot-security-helloworld-02.png",alt:"spring-boot-security-helloworld-02"}})]),t._v(" "),a("h3",{attrs:{id:"_1-1-默认用户名密码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-默认用户名密码"}},[t._v("#")]),t._v(" 1.1 默认用户名密码")]),t._v(" "),a("p",[t._v("Spring Security 默认提供了一个用户名为 user 的用户，其密码在控制台可以找到：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hemiao3000.gitee.io/java-note-img/images/spring-security/img/spring-boot-security-helloworld-03.png",alt:"spring-boot-security-helloworld-03"}})]),t._v(" "),a("p",[t._v("成功登录以后就可以正常访问了：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hemiao3000.gitee.io/java-note-img/images/spring-security/img/spring-boot-security-helloworld-04.png",alt:"spring-boot-security-helloworld-04"}})]),t._v(" "),a("h3",{attrs:{id:"_1-2-配置文件中配置用户名密码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-配置文件中配置用户名密码"}},[t._v("#")]),t._v(" 1.2 配置文件中配置用户名密码")]),t._v(" "),a("p",[t._v("刚才的案例中我们使用的是 Spring Security 提供的用户名和密码进行登录的，那么该如何配置自己的用户名和密码呢？")]),t._v(" "),a("p",[t._v("按照 Spring Boot 的自动配置原理，它肯定为其编写了一个 XXXProperties 的类作为配置，来查找一下：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hemiao3000.gitee.io/java-note-img/images/spring-security/img/spring-boot-security-helloworld-05.png",alt:"spring-boot-security-helloworld-05"}})]),t._v(" "),a("p",[t._v("找到了这个类就知道该如何配置了：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hemiao3000.gitee.io/java-note-img/images/spring-security/img/spring-boot-security-helloworld-06.png",alt:"spring-boot-security-helloworld-06"}})]),t._v(" "),a("p",[t._v("通过这几个地方，我们能够知道一些信息，配置必须使用 spring.security 前缀，然后可以看到 Spring Security 为我们初始化的用户名和密码，所以若是想修改配置，则应使用 "),a("code",[t._v("spring.security.user.name")]),t._v(" 和 "),a("code",[t._v("spring.security.user.password")]),t._v(" 。")]),t._v(" "),a("p",[t._v("在 Spring Boot 的配置文件中进行如下配置：")]),t._v(" "),a("div",{staticClass:"language-properties extra-class"},[a("pre",{pre:!0,attrs:{class:"language-properties"}},[a("code",[a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("spring.security.user.name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("tom")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("spring.security.user.password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[t._v("123")]),t._v("\n")])])]),a("p",[t._v("此时启动项目，将只能通过自己配置的用户名和密码登录。")]),t._v(" "),a("h3",{attrs:{id:"_1-3-配置类中配置用户名密码"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-配置类中配置用户名密码"}},[t._v("#")]),t._v(" 1.3 配置类中配置用户名密码")]),t._v(" "),a("p",[t._v("当然还可以通过配置类的方式进行配置，创建一个配置类去继承 "),a("strong",[t._v("WebSecurityConfigurerAdapter")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SecurityConfig")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebSecurityConfigurerAdapter")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("configure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AuthenticationManagerBuilder")]),t._v(" auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对密码进行加密。123 是密码明文，现在 Spring Security 强制性不允许明文存储密码。")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BCryptPasswordEncoder")]),t._v(" passwordEncoder "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BCryptPasswordEncoder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" password "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" passwordEncoder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("inMemoryAuthentication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("withUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tom"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("roles")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[t._v("注意")]),t._v(" "),a("p",[t._v("从 5.x 开始，强制性要求必须使用密码加密器"),a("small",[t._v("（PasswordEncode‏）")]),t._v("对原始密码"),a("small",[t._v("（注册密码）")]),t._v("进行加密。")]),t._v(" "),a("p",[t._v("因此，如果忘记指定 PasswordEncoder 会导致执行时会出现 "),a("code",[t._v('There is no PasswordEncoder mapped for the id "null"')]),t._v(" 异常。")]),t._v(" "),a("p",[t._v("Shiro 没有这个强制要求，CredentialsMatcher 你可用可不用。")])]),t._v(" "),a("p",[t._v("重新启动项目测试一下。会发现登录不上，观察控制台：")]),t._v(" "),a("p",[a("img",{attrs:{src:"https://hemiao3000.gitee.io/java-note-img/images/spring-security/img/spring-boot-security-helloworld-07.png",alt:"spring-boot-security-helloworld-07"}})]),t._v(" "),a("p",[t._v("这是因为我们在对密码加密的时候使用到了 "),a("strong",[t._v("BCryptPasswordEncoder")]),t._v(" 对象，而 Spring Security 在对密码比对的过程中不会『自己创建』加密器，因此，需要我们在 Spring IoC 容器中配置、创建好加密器的单例对象，以供它直接使用。")]),t._v(" "),a("p",[t._v("所以，我们还需要在容器中配置、创建加密器的单例对象"),a("small",[t._v("（上面那个 new 理论上可以改造成注入）")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PasswordEncoder")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("getPasswordEncoder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BCryptPasswordEncoder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("再次重新启动一切正常。")]),t._v(" "),a("h2",{attrs:{id:"_2-password-encoder"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-password-encoder"}},[t._v("#")]),t._v(" 2. Password Encoder")]),t._v(" "),a("p",[t._v("之前有提及，Spring Security 升级到 "),a("code",[t._v("5")]),t._v(" 版本后提高了安全要求：Spring Security 要求所有的密码的存储都『"),a("strong",[t._v("必须")]),t._v("』是加密形式的。为此，我们还在 Spring IoC 容器中配置了 "),a("strong",[t._v("PasswordEncoder")]),t._v(" 的单例对象用以供 Spring Security 使用。")]),t._v(" "),a("p",[t._v("PasswordEncoder 在两处场景会被使用到：")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("当我们实现注册功能时，要将用户在前端页面输入的明文密码使用 PasswordEncoder 进行加密后存储、持久化。")])]),t._v(" "),a("li",[a("p",[t._v("当用户在登录时，Spring Security 会将用户在前端页面输入的明文密码使用 PasswordEncoder 进行加密之后，再和由我们提供的密码『标准答案』进行比对。")])])]),t._v(" "),a("p",[t._v("Spring Security 使用 "),a("strong",[t._v("PasswordEncoder")]),t._v(" 对你提供的密码进行加密。该接口中有两个方法：加密方法，是否匹配方法。")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("加密方法"),a("small",[t._v("（"),a("strong",[t._v("encode")]),t._v("）")]),t._v("方法在用户注册时使用。在注册功能处，我们"),a("small",[t._v("（程序员）")]),t._v("需要将用户提供的密码加密后存储"),a("small",[t._v("（至数据库）")]),t._v("。")])]),t._v(" "),a("li",[a("p",[t._v("匹配方法 "),a("strong",[t._v("matches")]),t._v(" 方法是由 Spring Security 调用的。在登录功能处，Spring Security 要用它来比较登录密码和密码『标准答案』。")])])]),t._v(" "),a("p",[t._v("因此上面的配置改为如下形式更为合理：")]),t._v(" "),a("div",{staticClass:"language-java extra-class"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Slf4j")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Configuration")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SecurityConfig")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("extends")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WebSecurityConfigurerAdapter")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("private")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PasswordEncoder")]),t._v(" passwordEncoder"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Bean")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("PasswordEncoder")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("passwordEncoder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("BCryptPasswordEncoder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[t._v("@Override")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("configure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AuthenticationManagerBuilder")]),t._v(" auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("throws")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Exception")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" password "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("passwordEncoder")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("encode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"123"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        auth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("inMemoryAuthentication")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("withUser")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tom"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("password")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("password"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("roles")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"admin"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("Spring Security 内置的 Password Encoder 有：")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",{staticStyle:{"text-align":"left"}},[t._v("加密算法名称")]),t._v(" "),a("th",{staticStyle:{"text-align":"left"}},[t._v("PasswordEncoder")])])]),t._v(" "),a("tbody",[a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("NOOP")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("NoOpPasswordEncoder.getInstance()")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("SHA256")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("new StandardPasswordEncoder()")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("BCRYPT"),a("small",[t._v("（官方推荐）")])]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("new BCryptPasswordEncoder()")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("LDAP")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("new LdapShaPasswordEncoder()")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("PBKDF2")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("new Pbkdf2PasswordEncoder()")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("SCRYPT")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("new SCryptPasswordEncoder()")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("MD4")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v("new Md4PasswordEncoder()")])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("MD5")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v('new MessageDigestPasswordEncoder("MD5")')])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("SHA_1")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v('new MessageDigestPasswordEncoder("SHA-1")')])]),t._v(" "),a("tr",[a("td",{staticStyle:{"text-align":"left"}},[t._v("SHA_256")]),t._v(" "),a("td",{staticStyle:{"text-align":"left"}},[t._v('new MessageDigestPasswordEncoder("SHA-256")')])])])]),t._v(" "),a("p",[t._v("上述 Password Encoder 中有一个『无意义』的加密器："),a("strong",[t._v("NoOpPasswordEncoder")]),t._v(" 。它对原始密码没有做任何处理"),a("small",[t._v("（现在也被标记为废弃）")]),t._v("。")]),t._v(" "),a("blockquote",[a("p",[t._v('记得使用 @SuppressWarnings("deprecation") 去掉 IDE 的警告信息。')])]),t._v(" "),a("h2",{attrs:{id:"_3-多加密方案-自学、了解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-多加密方案-自学、了解"}},[t._v("#")]),t._v(" 3. 多加密方案（自学、了解）")]),t._v(" "),a("p",[t._v("Spring Security 在加密功能上比 Shiro『高级』一点的是，它在一个系统中支持存在多种加密方式。"),a("small",[t._v("尽管我们不一定会用到这个『高级』特性。")])]),t._v(" "),a("p",[t._v("简单来说，在 Shiro 中，一旦确定使用何种加密方式（算法），使用该系统的用户一定都是用同一种加密算法对密码进行加密，即，张三和李四"),a("small",[t._v("（在注册时）")]),t._v("都是使用 xxx 算法对各自的密码进行加密"),a("small",[t._v("（而后存储至数据库）")]),t._v("。")]),t._v(" "),a("p",[t._v("而 Spring Security 则可以实现这样的功能：张三"),a("small",[t._v("（在注册时）")]),t._v("使用的是 xxx 算法对自己的密码进行加密"),a("small",[t._v("（然后存储至数据库）")]),t._v("，而李四"),a("small",[t._v("（在注册时）")]),t._v("使用的是 yyy 算法对自己的密码进行加密"),a("small",[t._v("（而后存储至数据库）")]),t._v("。")]),t._v(" "),a("p",[t._v("Spring Security 之所以能实现这样的功能是因为，无论你是使用的何种加密算法，在加密后的密码的前面 Spring Security『拼』上了加密算法信息。形如：")]),t._v(" "),a("div",{staticClass:"language-text extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("{bcrypt}$2a$10$dXJ3SW6G7P50lGmMkkmwe.20cQQubK3.HZWzG3YB1tlRy.fqvM/BG\n\n{noop}password\n\n{pbkdf2}5d923b44a6d129f3ddf3e3c8d29412723dcbde72445e8ef6bf3b508fbf17fa4ed4d6b99ca763d8dc\n\n{scrypt}$e0801$8bWJaSu2IKSn9Z9kM+TPXfOc/9bdYSrN1oD9qfVThWEwdRTnO7re7Ei+fUZRJ68k9lTyuTeUp4of4g24hHnazw==$OAOec05+bXxvuu/1qZ6NUR+xQYvYv7BeL1QxwRpY5Pc=\n\n{sha256}97cde38028ad898ebc02e690819fa220e88c62e0699403e94fff291cfffaf8410849f27605abcbc0\n")])])]),a("p",[t._v("这样，在"),a("small",[t._v("（未来进行登录）")]),t._v("比对时，Spring Security『看见』这些密码时，就能知道『当初』注册时它们是使用何种密码加密的，进而再从 Spring IoC 容器中去取对应的 Password Encoder 来对用户输入密码进行同样的加密后，再比对。")]),t._v(" "),a("p",[t._v("为了方面我们的操作，Spring Security 提供了一个名为 "),a("strong",[t._v("PasswordEncoderFactories")]),t._v(" 的工具类来便于我们使用各种 PasswordEncoder 。")]),t._v(" "),a("p",[t._v("PasswordEncoderFactories 的 "),a("strong",[t._v("createDelegatingPasswordEncoder")]),t._v(" 方法会返回一个 "),a("strong",[t._v("DelegatingPasswordEncoder")]),t._v(" ，故名思意，DelegatingPasswordEncoder 会代理所有的 Spring Security PasswordEncoder 加密器。")]),t._v(" "),a("p",[t._v("当你使用 DelegatingPasswordEncoder 进行密码加密时，它会要求你传入一个加密算法的名字，它再『帮你』调用那个 PasswordEncoder 对你的密码进行加密后，并且它会在加密密码的前面再拼接上对应的名字。")]),t._v(" "),a("h2",{attrs:{id:"_4-消失-的登录功能"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-消失-的登录功能"}},[t._v("#")]),t._v(" 4. “消失”的登录功能")]),t._v(" "),a("p",[t._v("不知道大家有没有注意到，其实，我们的 Controller 中还没有写登录功能（这和 Shiro 非常不同）。但是，之前的示例中，就已经有了完整的『登录』（甚至『退出』）功能，并且，Spring Security 似乎还能记住我们已经登陆过"),a("small",[t._v("（当我们第二次访问页面时，它不会要求我们再次登录）")]),t._v("！")]),t._v(" "),a("h3",{attrs:{id:"_3-1-登录功能的演示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-登录功能的演示"}},[t._v("#")]),t._v(" 3.1 登录功能的演示")]),t._v(" "),a("h3",{attrs:{id:"_3-2-记录登录状态的演示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-记录登录状态的演示"}},[t._v("#")]),t._v(" 3.2 记录登录状态的演示")])])}),[],!1,null,null,null);s.default=e.exports}}]);